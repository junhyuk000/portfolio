{% extends "movie_base.html" %}
{% block css %}
<style>
/* ğŸ¥ ìœ íŠœë¸Œ ì˜ìƒ ì „ì²´ ì»¨í…Œì´ë„ˆ */
    .video-container {
        width: 90%;  /* ë¸Œë¼ìš°ì € ë„ˆë¹„ì˜ 90% */
        max-width: 1200px; /* ìµœëŒ€ í¬ê¸° ì œí•œ */
        height: 70vh; /* ë¸Œë¼ìš°ì € ë†’ì´ì˜ 70% */
        margin: auto;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* ğŸï¸ ìœ íŠœë¸Œ ì˜ìƒ */
    .video-frame {
        width: 100%;
        height: 100%;
        border: none;
        object-fit: cover;
    }


    .button-container {
    display: flex;
    flex-wrap: wrap; /* âœ… ë²„íŠ¼ì´ í™”ë©´ì— ë§ê²Œ ì¤„ë°”ê¿ˆ */
    justify-content: center; /* âœ… ê°€ìš´ë° ì •ë ¬ */
    gap: 10px; /* âœ… ë²„íŠ¼ ê°„ê²© ì¡°ì • */
    margin-top: 20px;
    margin-bottom: 20px; /* âœ… í•˜ë‹¨ ì—¬ë°± ì¤„ì´ê¸° */
    }

    .button-container .btn {
        min-width: 120px; /* âœ… ë²„íŠ¼ ìµœì†Œ ë„ˆë¹„ ì„¤ì • */
        padding: 10px 15px; /* âœ… ë²„íŠ¼ ì—¬ë°± ì„¤ì • */
        font-size: 14px; /* âœ… ë²„íŠ¼ ê¸€ê¼´ í¬ê¸° ì¤„ì´ê¸° */
    }

    /* âœ… ì°¨íŠ¸ê°€ ëª¨ë°”ì¼ì—ì„œë„ ì ì ˆí•œ í¬ê¸°ë¡œ í‘œì‹œë˜ë„ë¡ ì¡°ì • */
    .chart-container {
        display: flex;
        justify-content: center;
        max-width: 100%;
        overflow-x: auto;
    }

    canvas {
        max-width: 100%;
        height: auto !important;
    }

    /* âœ… í…Œì´ë¸”ì´ ëª¨ë°”ì¼ì—ì„œë„ ë„˜ì¹˜ì§€ ì•Šë„ë¡ ì¡°ì • */
    .table-container {
        width: 100%;
        overflow-x: auto;
    }

    .table {
        min-width: 400px; /* âœ… ìµœì†Œ ë„ˆë¹„ ì„¤ì •í•˜ì—¬ ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ í•¨ */
    }

    /* ğŸ“Œ ëª¨ë°”ì¼ì—ì„œë§Œ í…Œì´ë¸” ë°˜ì‘í˜• ì ìš© */
    @media (max-width: 768px) {
        .row {
            display: flex;
            flex-direction: column; /* ëª¨ë°”ì¼ì—ì„œ í…Œì´ë¸”ì´ ê·¸ë˜í”„ ì•„ë˜ë¡œ ì´ë™ */
        }

        .table-container {
            overflow-x: auto; /* í‘œê°€ ë„˜ì¹  ê²½ìš° ê°€ë¡œ ìŠ¤í¬ë¡¤ ì¶”ê°€ */
            max-width: 100%; /* í™”ë©´ì„ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì„¤ì • */
        }

        .table {
            min-width: 100%; /* í‘œ í¬ê¸°ê°€ ê³ ì •ë˜ì§€ ì•Šê³  ì¡°ì •ë˜ë„ë¡ ì„¤ì • */
            display: block;
            overflow-x: auto;
            white-space: nowrap; /* í‘œ ë‚´ìš© ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }
    }


    .trailer-container {
        width: 100%;
        max-width: 1200px; /* ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
        margin: 0 auto 20px;
        text-align: center;
    }

    #trailer {
        width: 100%;
        height: 600px; /* í¬ê¸° í™•ëŒ€ */
    }

    /* ëª¨ë°”ì¼ í™”ë©´ì—ì„œ ë†’ì´ ì¡°ì • */
    @media (max-width: 768px) {
        #trailer {
            height: 300px; /* ëª¨ë°”ì¼ì—ì„œëŠ” ë” ì‘ê²Œ */
        }
    }

    .swiper {
        position: relative;
        width: 100%;
        max-width: 100vw;
        height: 650px; /* âœ… ë†’ì´ ì¡°ì • */
        padding: 40px 0;
        overflow: hidden;
    }

    .swiper-wrapper {
        display: flex;
        align-items: center;
    }

    .swiper-slide {
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 250px;
        position: relative;
    }

    /* âœ… ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    .swiper-slide img {
        width: 250px;
        height: 380px;
        object-fit: cover;
        border-radius: 15px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease-in-out;
    }

    /* âœ… ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ í™•ëŒ€ íš¨ê³¼ */
    .swiper-slide:hover img {
        transform: scale(1.05);
    }

    /* âœ… ê¸°ì¡´ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ìœ ì§€ */
    .text-overlay {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        text-align: center;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 10px;
        transition: opacity 0.3s ease-in-out;
        opacity: 0;
    }

    .swiper-slide:hover .text-overlay {
        opacity: 1;
    }

    .text-overlay h5,
    .text-overlay p {
        color: #ffffff;
        margin: 5px 0;
    }

    /* âœ… Rank í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .rank-text {
        font-size: 18px;
        font-weight: bold;
        margin-top: 10px;
        color: #333;
        text-align: center;
    }

    /* âœ… í˜ì´ì§€ë„¤ì´ì…˜ ì¤‘ì•™ ì •ë ¬ */
    .swiper-pagination {
        position: absolute;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
    }

    .swiper-pagination-bullet {
        background-color: #bfa187 !important;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        opacity: 0.7;
    }

    .swiper-pagination-bullet-active {
        background-color: #8a6f55 !important;
    }

    /* âœ… ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
    .swiper-button-next,
    .swiper-button-prev {
        color: #bfa187 !important;
        width: 40px;
        height: 40px;
        z-index: 10;
        top: 50%;
        transform: translateY(-50%);
    }

    .swiper-button-next {
        right: 10px;
    }

    .swiper-button-prev {
        left: 10px;
    }

    #map { width: 100%; height: 500px; }
    #placesList {
        list-style: none;
        padding: 0;
        margin: 10px 0;
        max-height: 200px;
        overflow-y: auto;
    }
    #placesList li {
        margin: 5px 0;
        cursor: pointer;
        padding: 5px;
        border: 1px solid #ddd;
        background: #f9f9f9;
    }
    #placesList li:hover { background: #e0e0e0; }
</style>
{% endblock %}



{% block content %}
<h2 style="color:  #283618; text-align: center;">ğŸ¬ ì˜¤ëŠ˜ì˜ ì˜í™” </h2>
<h3 style="color:  #bc6c25; text-align: center;">{% for movie in movies_info %}{% if movie.rank == 1 %}{{movie.title}}{%endif%}{% endfor %}</h3>

<!-- ğŸ¥ YouTube ì˜ìƒ (ì „ì²´ í™”ë©´ì— ë” ê°€ê¹ê²Œ í™•ëŒ€) -->
<div class="video-container">
    <iframe id="trailer" class="video-frame" frameborder="0"
        allow="autoplay; encrypted-media" allowfullscreen>
    </iframe>
</div>
<div class="container">

    <div class="swiper">
        <h3 style="color: #283618; text-align: center;">ì˜í™” ìˆœìœ„</h3><p>ì˜í™” ì´ë¯¸ì§€ë¥¼ í´ë¦­í•´ ì£¼ì„¸ìš”!</p>
        <div class="swiper-wrapper">
            {% for movie in movies_info|sort(attribute='rank') %}  <!-- âœ… Rank ìˆœ ì •ë ¬ -->
            <div class="swiper-slide">
                <h4 class="rank-text" style="color: #dda15e;">{{ movie.rank }}ìœ„</p>
                <h4 class="rank-text" style="color: #606c38;">{{ movie.title }}</p>
                <img src="/popcornapp/static/images/{{ movie.filename }}" alt="{{ movie.title }}">
                
                <!-- âœ… ê¸°ì¡´ ì •ë³´ ìœ ì§€ -->
                <div class="text-overlay">
                    <h5>{{ movie.title }}</h5>
                    <p>í‰ì : {{ movie.rating }}</p>
                    <p>ë¦¬ë·°: {{ movie.reviews }}</p>
                    <a href="/popcornapp/movie_youtube/{{ movie.title }}" class="btn btn-outline-light mx-2">ì˜ˆê³ í¸</a>
                    <a href="/popcornapp/reviews/{{ movie.title }}/{{ movie.id }}" class="btn btn-outline-light mx-2">Review</a>
                </div>


                
            </div>
            {% endfor %}
        </div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
    </div>
</div>
<div class="text-center">

        <!-- ì°¨íŠ¸ ì „í™˜ ë²„íŠ¼ -->
        <h3 class="mb-4"  id="rank-title" style="color:#283618;">ì¼ì¼ ê´€ê°ìˆ˜</h3>
        <div class="d-flex flex-wrap justify-content-center mt-4 gap-2">
            
            <button class="btn btn-outline-light mx-2" onclick="updateChartAndRank('t_audience')" style="color:  #ad7b67;">ì¼ì¼ ê´€ê°ìˆ˜</button>
            <button class="btn btn-outline-light mx-2" onclick="updateChartAndRank('c_audience')" style="color:  #ad7b67;">ëˆ„ì  ê´€ê°ìˆ˜</button>
            <button class="btn btn-outline-light mx-2" onclick="updateChartAndRank('t_sales')" style="color:  #ad7b67;">ì¼ì¼ ë§¤ì¶œì•¡</button>
            <button class="btn btn-outline-light mx-2" onclick="updateChartAndRank('c_sales')" style="color:  #ad7b67;">ëˆ„ì  ë§¤ì¶œì•¡</button>
        </div><br>
    <div class="row">
        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <div class="col-md-8">
            <canvas id="chart" style="max-width: 100%; height: 60vh;"></canvas>
        </div>


        <div class="col-md-4">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th style="background-color: #283618; color: white;">Rank</th>
                        <th style="background-color: #283618; color: white;">Title</th>
                    </tr>
                </thead>
                <tbody id="ranking-table-body">
                    <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ë°ì´í„° ì¶”ê°€ -->
                </tbody>
            </table>
        </div>


    </div>
</div><br><br>

<h3 style="color: #283618;">ê·¼ì²˜ ì˜í™”ê´€</h3>
<input type="text" id="searchInput" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 300px;">
<button id="searchButton">ê²€ìƒ‰</button>
<div id="map"></div>
<ul id="placesList"></ul>

{% endblock %}


{% block js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=be47724c48a9357381269e671a99079c&libraries=services"></script>
<script src="/popcornapp/static/js/map.js"></script>
<script>
     function loadTrailer(movieTitle) {
        if (!movieTitle) return;

        const trailerIframe = document.getElementById('trailer');
        const query = encodeURIComponent(movieTitle + " official trailer");

        fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${query}&type=video&key=AIzaSyCStt6OCKJD2YY1wOPVkR88PZMjknY3EPw`)
            .then(response => response.json())
            .then(data => {
                if (!data.items || data.items.length === 0) {
                    console.error("âŒ ìœ íŠœë¸Œ APIì—ì„œ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                    return;
                }
                const videoId = data.items[0].id.videoId;
                trailerIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&rel=0`;
            })
            .catch(error => console.error("YouTube API Error:", error));
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', function() {
        const moviesInfo = {{ movies_info | tojson }};
        const topMovie = moviesInfo.find(movie => movie.rank === 1);
        if (topMovie) {
            loadTrailer(topMovie.title);
        }
    });


    document.addEventListener("DOMContentLoaded", function() {
        var swiper = new Swiper(".swiper", {
        slidesPerView: 5, // ê¸°ë³¸ì ìœ¼ë¡œ 5ê°œì”© í‘œì‹œ
        slidesPerGroup: 1,
        spaceBetween: 20,
        centeredSlides: false,
        loop: true,
        autoplay: {
            delay: 2000, // 2ì´ˆë§ˆë‹¤ ìŠ¬ë¼ì´ë“œ ë³€ê²½
            disableOnInteraction: false,
        },
        speed: 600,
        pagination: {
            el: ".swiper-pagination",
            clickable: true,
        },
        navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
        },
        breakpoints: {
            320: { // ëª¨ë°”ì¼ ì‘ì€ í™”ë©´ (ì˜ˆ: iPhone SE)
                slidesPerView: 1,
                spaceBetween: 5
            },
            480: { // ì¼ë°˜ ëª¨ë°”ì¼ í™”ë©´
                slidesPerView: 2,
                spaceBetween: 10
            },
            768: { // íƒœë¸”ë¦¿ í™”ë©´
                slidesPerView: 3,
                spaceBetween: 15
            },
            1024: { // ë°ìŠ¤í¬í†± (ì»¨í…Œì´ë„ˆ 1600px ê¸°ì¤€)
                slidesPerView: 5, // ğŸŸ¢ 5ê°œì”© ë³´ì—¬ì¤Œ
                spaceBetween: 20
            }
        }
    });


        document.querySelector(".swiper").addEventListener("mouseenter", function() {
            swiper.autoplay.stop();
        });
        document.querySelector(".swiper").addEventListener("mouseleave", function() {
            swiper.autoplay.start();
        });
    });

    // í…œí”Œë¦¿ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const moviesData = {{ movies_data | tojson }};
    const dataSets = {
        t_sales: moviesData.map(movie => movie.t_sales),
        c_sales: moviesData.map(movie => movie.c_sales),
        t_audience: moviesData.map(movie => movie.t_audience),
        c_audience: moviesData.map(movie => movie.c_audience),
    };
    const movieNames = moviesData.map(movie => movie.title);

    let currentMetric = 't_audience';

    // ë§‰ëŒ€ ìƒ‰ìƒì„ ì œëª©ë³„ë¡œ ë‹¤ë¥´ê²Œ ì„¤ì •
    const barColors = movieNames.map((_, index) => {
        const colors = [
            'rgba(255, 99, 132, 0.8)',  // ë¹¨ê°„ìƒ‰
            'rgba(54, 162, 235, 0.8)', // íŒŒë€ìƒ‰
            'rgba(255, 206, 86, 0.8)', // ë…¸ë€ìƒ‰
            'rgba(75, 192, 192, 0.8)', // ì´ˆë¡ìƒ‰
            'rgba(153, 102, 255, 0.8)', // ë³´ë¼ìƒ‰
            'rgba(255, 159, 64, 0.8)',  // ì£¼í™©ìƒ‰
            'rgba(99, 255, 132, 0.8)',  // ì—°ì´ˆë¡ìƒ‰
        ];
        return colors[index % colors.length]; // ìƒ‰ìƒ ë°°ì—´ì„ ë°˜ë³µì ìœ¼ë¡œ í• ë‹¹
    });

    // ì°¨íŠ¸ ì´ˆê¸°í™”
    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: movieNames,
            datasets: [{
                label: 'ì¼ì¼ ê´€ê°ìˆ˜',
                data: dataSets[currentMetric],
                backgroundColor: barColors, // ë…¸ë€ìƒ‰ ë§‰ëŒ€
                borderColor: barColors.map(color => color.replace('0.8','1')),
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: {
                    display: false // ë²”ë¡€ í‘œì‹œ ì•ˆ í•¨
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: 'black' // Xì¶• í…ìŠ¤íŠ¸ ìƒ‰ìƒ
                    },
                    grid: {                        
                        color: 'rgba(0, 0, 0, 0.2)', // Xì¶• ê·¸ë¦¬ë“œ ì„  ê°€ì‹œì„± ê°œì„ 
                        drawBorder: true
                    }
                },
                y: {
                    ticks: {
                        color: 'black' // Yì¶• í…ìŠ¤íŠ¸ ìƒ‰ìƒ
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.2)', // Yì¶• ê·¸ë¦¬ë“œ ì„  ê°€ì‹œì„± ê°œì„ 
                        drawBorder: true
                    }
                }
            },
            responsive: true,
            maintainAspectRatio: false
        }
    });

// ì°¨íŠ¸ ë° ìˆœìœ„ ì—…ë°ì´íŠ¸
    function updateChartAndRank(metric) {
        currentMetric = metric;

        // ì°¨íŠ¸ ë°ì´í„° ë° ì œëª© ì—…ë°ì´íŠ¸
        chart.data.datasets[0].data = dataSets[metric];
        chart.data.datasets[0].label = getLabel(metric);
        chart.update();

        // í‘œ ì—…ë°ì´íŠ¸
        updateRanking(metric);

        // ìˆœìœ„í‘œ ì œëª© ì—…ë°ì´íŠ¸
        const rankTitle = document.getElementById('rank-title');
        rankTitle.textContent = `${getLabel(metric)}`;
    }


    // ìˆœìœ„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateRanking(metric) {
        const rankingTableBody = document.getElementById('ranking-table-body');
        rankingTableBody.innerHTML = ''; // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ

        // ë°ì´í„° ì •ë ¬
        const sortedMovies = [...moviesData].sort((a, b) => b[metric] - a[metric]);

        // ì •ë ¬ëœ ë°ì´í„°ë¡œ í‘œ ìƒì„±
        sortedMovies.forEach((movie, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="color: black;">${index + 1}</td>
                <td style="color: black; white-space: nowrap;">${movie.title}</td>
            `;
            rankingTableBody.appendChild(row);
        });
    }

    // ë©”íŠ¸ë¦­ë³„ ë ˆì´ë¸” ë°˜í™˜
    function getLabel(metric) {
        switch (metric) {
            case 't_audience': return 'ì¼ì¼ ê´€ê°ìˆ˜';
            case 'c_audience': return 'ëˆ„ì  ê´€ê°ìˆ˜';
            case 't_sales': return 'ì¼ì¼ ë§¤ì¶œì•¡';
            case 'c_sales': return 'ëˆ„ì  ë§¤ì¶œì•¡';
            default: return '';
        }
    }
    // ì´ˆê¸° ìˆœìœ„ ì—…ë°ì´íŠ¸
    updateRanking(currentMetric);

    function loadKakaoMap() {
        if (window.kakao && window.kakao.maps) {
            console.log("ì¹´ì¹´ì˜¤ ë§µ API ì´ë¯¸ ë¡œë“œë¨");
            if (typeof initializeMap === "function") {
                initializeMap(); // ë§µ ì´ˆê¸°í™” ì‹¤í–‰
            } else {
                console.error("âŒ initializeMap í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ");
            }
            return;
        }

        var script = document.createElement("script");
        script.src = "https://dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_API_KEY&libraries=services";
        script.async = true;
        script.defer = true;

        script.onload = function () {
            console.log("âœ… ì¹´ì¹´ì˜¤ ë§µ API ë¡œë“œ ì™„ë£Œ");
            if (typeof initializeMap === "function") {
                initializeMap();
            } else {
                console.error("âŒ initializeMap í•¨ìˆ˜ê°€ ì—¬ì „íˆ ì •ì˜ë˜ì§€ ì•ŠìŒ");
            }
        };

        script.onerror = function () {
            console.error("ğŸš¨ ì¹´ì¹´ì˜¤ ë§µ API ë¡œë“œ ì‹¤íŒ¨");
            alert("ì¹´ì¹´ì˜¤ ë§µì„ ë¡œë“œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        };

        document.head.appendChild(script);
    }

    window.onload = function () {
        console.log("ğŸŒ Window onload ì‹¤í–‰");
        loadKakaoMap();
    };
</script>
{% endblock %}
