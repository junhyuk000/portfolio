{% extends 'movie_base.html' %}
{% block css %}
<style>
    /* í‘œê°€ ëª¨ë°”ì¼ì—ì„œ ë„˜ì¹  ê²½ìš° ìë™ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ì¡°ì • */
    .table-responsive {
        width: 100%;
        display: block;
    }

    table {
        width: 100%; /* í‘œì˜ ì „ì²´ ë„ˆë¹„ë¥¼ í¬ê²Œ ì¡°ì • */
    }

    table td, table th {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
    }
    /* í‘œì˜ hover íš¨ê³¼ */
    table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.1); /* ì—°í•œ íšŒìƒ‰ */
        transition: background-color 0.3s ease-in-out;
    }

    /* íˆ´íŒ ìŠ¤íƒ€ì¼ */
    .tooltip-custom {
        position: absolute;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px;
        border-radius: 5px;
        font-size: 14px;
        max-width: 300px;
        display: none;
        z-index: 1000;
        white-space: normal;
    }

    /* ì •ë ¬ ë²„íŠ¼ & í•„í„° í•œ ì¤„ ì •ë ¬ */
    .filters-container {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
    }

    /* ê²€ìƒ‰ í•„í„° (ì œëª©, ê°ë…, ë°°ìš°, ê²€ìƒ‰ë²„íŠ¼) í•œ ì¤„ ì •ë ¬ */
    .search-container {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
    }

    /* ê²€ìƒ‰ ë²„íŠ¼ í¬ê¸° ì¡°ì • */
    .search-btn {
        width: auto;
        white-space: nowrap;
        padding: 5px 15px;
    }

    /* ê²€ìƒ‰ ì…ë ¥ í•„ë“œ í¬ê¸° ì¡°ì • */
    .form-control {
        max-width: 200px;
    }
    /* ë°˜ì‘í˜• ë””ìì¸: í™”ë©´ì´ 600px ì´í•˜ì¼ ë•Œ í…Œì´ë¸”ì„ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ì¡°ì • */
    @media (max-width: 600px) {
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* iOSì—ì„œ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
        }

        table {
            min-width: 600px; /* ìµœì†Œ í¬ê¸° ì§€ì •í•˜ì—¬ ê°€ë¡œ ìŠ¤í¬ë¡¤ ìœ ë„ */
        }
    }
</style>
{% endblock %}

{% block content %}
<h2 class="mt-4 mb-4 text-center">ğŸ¬ ëª¨ë“  ì˜í™” ë°ì´í„° ì¡°íšŒ</h2>

<div class="container">
    <!-- ì •ë ¬ ë²„íŠ¼ + ì¥ë¥´ & êµ­ê°€ í•„í„° -->
    <div class="row mb-3">
        <div class="col-12 filters-container">
            <div class="btn-group" role="group">
                <button id="sort-total_audience" class="btn btn-primary sort-btn" onclick="changeOrderBy('total_audience')">
                    ğŸ‘¥ ê´€ëŒê° ìˆœ
                </button>
                <button id="sort-total_sales" class="btn btn-outline-primary sort-btn" onclick="changeOrderBy('total_sales')">
                    ğŸ’° ë§¤ì¶œì•¡ ìˆœ
                </button>
            </div>
            <select id="genre" class="form-control">
                <option value="">ğŸ­ ì¥ë¥´</option>
                {% for g in filters.genres %}
                <option value="{{ g }}">{{ g }}</option>
                {% endfor %}
            </select>
            <select id="nation" class="form-control">
                <option value="">ğŸŒ êµ­ê°€</option>
                {% for n in filters.nations %}
                <option value="{{ n }}">{{ n }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- ì œëª©, ê°ë…, ë°°ìš°, ê²€ìƒ‰ ë²„íŠ¼ í•œ ì¤„ ì •ë ¬ -->
    <div class="row mb-3">
        <div class="col-12 search-container">
            <input type="text" id="title" class="form-control" placeholder="ğŸ¬ ì œëª©">
            <input type="text" id="director" class="form-control" placeholder="ğŸ¬ ê°ë…">
            <input type="text" id="actor" class="form-control" placeholder="ğŸ¬ ë°°ìš°">
            <button class="btn btn-primary search-btn" onclick="searchMovies()">ğŸ” ê²€ìƒ‰</button>
        </div>
    </div>

    <!-- ë°˜ì‘í˜• í…Œì´ë¸” -->
    <div class="table-responsive">
        <table id="movieTable" class="table table-striped">
            <thead>
                <tr>
                    <th>ìˆœìœ„</th>
                    <th>ì œëª©</th>
                    <th>ì¥ë¥´</th>
                    <th>êµ­ê°€</th>
                    <th>ê°ë…</th>
                    <th>ë°°ìš°</th>
                    <th>ë§¤ì¶œì•¡</th>
                    <th>ê´€ê°ìˆ˜</th>
                    <th>ê°œë´‰ì¼</th>
                    <th>ì˜ˆê³ í¸</th>
                </tr>
            </thead>
            <tbody id="movieData"></tbody>
        </table>
    </div>
        <!-- í˜ì´ì§€ë„¤ì´ì…˜ ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-center">
                    <div id="pagination" class="btn-group" role="group"></div>
                </div>
            </div>
        </div>
</div>
<!-- íˆ´íŒ ìš”ì†Œ ì¶”ê°€ -->
<div id="tooltip" class="tooltip-custom"></div>

<!-- AJAX -->
<script>
    function searchMovies() {
        let query = `?title=${document.getElementById("title").value}&genre=${document.getElementById("genre").value}&nation=${document.getElementById("nation").value}&director=${document.getElementById("director").value}&actor=${document.getElementById("actor").value}`;
        fetch(`/popcornapp/filter${query}`)
            .then(response => response.json())
            .then(data => updateTable(data));
    }
    let currentPage = 1;
    let currentOrderBy = 'total_audience';  // ê¸°ë³¸ ì •ë ¬ ê¸°ì¤€

    function updateTable(data) {
        const tbody = document.getElementById('movieData');
        tbody.innerHTML = '';

        if (data.data && data.data.length > 0) {
            data.data.forEach(movie => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${movie.rank}</td>
                    <td>
                        <span class="movie-title" data-tooltip="${movie.summary || 'ì„¤ëª… ì—†ìŒ'}">
                            ${movie.movie_title}
                        </span>
                    </td>
                    <td>${movie.genre || '-'}</td>
                    <td>${movie.nations || '-'}</td>
                    <td>${movie.director || '-'}</td>
                    <td>${movie.actors || '-'}</td>
                    <td>${formatNumber(movie.total_sales)}</td>
                    <td>${formatNumber(movie.total_audience)}</td>
                    <td>${movie.release_date || '-'}</td>
                    <td><a href="/popcornapp/movie_youtube/${encodeURIComponent(movie.movie_title)}" target="_blank" class="btn btn-sm btn-outline-success">â–¶ ì˜ˆê³ í¸</a></td>
                `;
                tbody.appendChild(row);
            });

            updatePagination(data.pages);
            setupTooltips();
        } else {
            tbody.innerHTML = `<tr><td colspan="9" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            document.getElementById('pagination').innerHTML = '';
        }
    }

    function setupTooltips() {
        const tooltip = document.getElementById('tooltip');
        
        document.querySelectorAll('td').forEach(cell => {
            // ì…€ ì•ˆì˜ í…ìŠ¤íŠ¸ê°€ ìƒëµë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (cell.offsetWidth < cell.scrollWidth) {
                cell.addEventListener('mouseenter', (e) => {
                    tooltip.innerText = e.target.innerText; // ì›ë³¸ ì „ì²´ í…ìŠ¤íŠ¸ í‘œì‹œ
                    tooltip.style.display = 'block';
                    tooltip.style.left = `${e.pageX + 10}px`;
                    tooltip.style.top = `${e.pageY + 10}px`;
                });

                cell.addEventListener('mousemove', (e) => {
                    tooltip.style.left = `${e.pageX + 10}px`;
                    tooltip.style.top = `${e.pageY + 10}px`;
                });

                cell.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
            }
        });
    }

    function updatePagination(totalPages) {
        const pagination = document.getElementById('pagination');
        let paginationHtml = '';
        
        // ì²˜ìŒ í˜ì´ì§€ë¡œ ì´ë™
        paginationHtml += `
            <button class="btn btn-secondary me-2" 
                    onclick="changePage(1)"
                    ${currentPage === 1 ? 'disabled' : ''}>
                â‰ª
            </button>
        `;
        
        // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
        paginationHtml += `
            <button class="btn btn-secondary me-2" 
                    onclick="changePage(${currentPage - 1})"
                    ${currentPage === 1 ? 'disabled' : ''}>
                ï¼œ
            </button>
        `;
        
        // í˜ì´ì§€ ë²ˆí˜¸ë“¤ (í˜„ì¬ í˜ì´ì§€ ì£¼ë³€ 5ê°œë§Œ í‘œì‹œ)
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);
        
        if (startPage > 1) {
            paginationHtml += '<span class="mx-2">...</span>';
        }
        
        for (let i = startPage; i <= endPage; i++) {
            if (i === currentPage) {
                paginationHtml += `
                    <button class="btn btn-primary mx-1">${i}</button>
                `;
            } else {
                paginationHtml += `
                    <button class="btn btn-outline-primary mx-1" 
                            onclick="changePage(${i})">
                        ${i}
                    </button>
                `;
            }
        }
        
        if (endPage < totalPages) {
            paginationHtml += '<span class="mx-2">...</span>';
        }
        
        // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
        paginationHtml += `
            <button class="btn btn-secondary ms-2" 
                    onclick="changePage(${currentPage + 1})"
                    ${currentPage === totalPages ? 'disabled' : ''}>
                ï¼
            </button>
        `;
        
        // ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì´ë™
        paginationHtml += `
            <button class="btn btn-secondary ms-2" 
                    onclick="changePage(${totalPages})"
                    ${currentPage === totalPages ? 'disabled' : ''}>
                â‰«
            </button>
        `;
        
        pagination.innerHTML = paginationHtml;
    }

    function changePage(page) {
        currentPage = page;
        searchMovies();
    }

    function changeOrderBy(orderBy) {
        currentOrderBy = orderBy;
        currentPage = 1;  // ì •ë ¬ ê¸°ì¤€ì´ ë°”ë€Œë©´ ì²« í˜ì´ì§€ë¡œ ì´ë™
        searchMovies();
        
        // ì •ë ¬ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        });
        document.getElementById(`sort-${orderBy}`).classList.remove('btn-outline-primary');
        document.getElementById(`sort-${orderBy}`).classList.add('btn-primary');
    }

    function searchMovies() {
        let query = `?page=${currentPage}&order_by=${currentOrderBy}&title=${document.getElementById("title").value}&genre=${document.getElementById("genre").value}&nation=${document.getElementById("nation").value}&director=${document.getElementById("director").value}&actor=${document.getElementById("actor").value}`;
        fetch(`/popcornapp/filter${query}`)
            .then(response => response.json())
            .then(data => updateTable(data));
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° ë¡œë”©
    document.addEventListener('DOMContentLoaded', function() {
        currentPage = 1;
        searchMovies();
    });

    function formatNumber(num) {
        return num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '-';
    }
</script>

{% endblock %}
